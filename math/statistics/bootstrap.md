# bootstrap

## 简介

Bootstrapping 是一种通过重新采样估计统计量分布的过程。该技术通过随机抽样方法可用于抽样分布几乎任何统计量的估计。与传统的参数方法相比，Bootstrapping 方法更**具有一般性**。bootstrap 方法需要在计算机上作较多计算，由于现代计算机速度很快，bootstrapping 方法已经成为一种流行方法。

这里的一般性，是指不需要知道总体分布，就可以计算标准差或置信区间。

bootstrapping 是现代统计学较为流行的一种方法，在**小样本时效果很好**。通过方差的估计可以构造置信区间，使其运用范围得到进一步延伸。

bootstrapping 的基本思想是，通过对样本数据进行重采样，然后根据重采样数据对样本进行推断（重采样->样本），可以对从样本数据到总体（样本->总体）的推断进行建模。由于总体未知，因此样本统计量相对其总体的真实误差也未知。在 bootstrapping 重采样中，“总体”实际上就是样本，这是已知的，因此，从重采样数据（重采样->样本）推断真实样本的误差是可测量的。

更准确地说，bootstrapping 的工作原理就是将给定样本，推断真实概率分布 $J$，转换为给定重采样数据，推断经验分布 $\hat{J}$。由于我们知道经验分布 $\hat{J}$，因此可以评估使用重采样数据推断 $\hat{J}$ 的准确性。如果 $\hat{J}$ 是 $J$ 的合理近似值，则可以推断出对 J 推断的质量。

例如，假设我们对全世界人口的平均身高感兴趣。我们无法测量全球所有人的身高，因此只抽取一小部分进行测量。假设样本大小为 $N$，即我们测量了 $N$ 个人的身高。从这个样本，只能得到一个平均身高的估计值。为了推断总体，我们需要了解计算出的平均值的变异性。最简单的 bootstrap 方法对原始样本，使用计算机从中抽样大小为 $N$ 的样本（称为 bootstrap 样本）。bootstrap 样本通过放回抽样的形式从原始样本抽取，例如，可以从 $[1,2,3,4,5]$ 重新抽样 5 次得到 $[2,5,4,4,1]$ 样本。假设 $N$ 足够大，在实际应用中，bootstrap 样本与原始样本完全相同的可能性几乎为 0。重复很多次（通常为 1000 或 10000 次），对每个 bootstrap 样本计算平均值（称为 bootstrap 估计值），就可以得到一个 bootstrap 平均值的直方图。该直方图提供了样本平均值的分布（这里以平均值来描述，该方法也可以用于几乎所有其它统计量）。

### 优势

bootstrap 方法的一大优势是简单。它很直接，可用于推导分布很复杂的估计量（如百分位数、比例、相关系数等）的标准误差和执行区间的估计值。

虽然简单，bootstrapping 可用于很复杂的抽样设计，如总体分为 $s$ 层，每层包含 $n_s$ 个样本，剂量反应实验就是一个典型示例，对每层都可以使用 bootstrapping。

bootstrap 也可以用于控制和检查结果的稳定性。虽然对于大多数问题来说，不可能知道真正的置信区间，但 bootstrap 比使用样本方差和正态假设获得标准区间更准确。

bootstrapping 还避免的重复实验获得数据的成本。

### 缺点

bootstrapping 很大程度上取决于使用的估计量，尽管简单，但单纯使用 bootstrapping 不一定总能得到渐近有效的结果，且结果可能不一致。bootstrapping 的结果取决于样本的代表性，bootstrapping 有两个重要的前提假设：样本的独立性以及样本量足够大。

另外，bootstrapping 可能很耗时，可用于的 bootstrapping 软件不多。

### 推荐

随着计算机算力的提高，学者建议使用更多 bootstrap 样本。如果结果非常重要，那么在计算能力和时间允许的条件下，应使用尽可能多的合理样本。增加样本数量并不能增加原始数据的信息量，只能减少由 bootstrap 本身产生的随机抽样误差。此外，有证据表明，样本数量超过 100 对标准误差估计的改善微乎其微。事实上，根据 bootstrap 最初开发者的说法，即使样本量设置为 50 也可以得到相当好的标准误差估计值。

Adèr 等建议在以下情况使用 bootstrap：

- 当感兴趣的统计数据的理论分布复杂或未知时，由于 bootstrap 与分布无关，因此它提供了一种间接方法来评估样本所属总体分布的属性以及该分布的参数。
- 当样本量不足以进行直接统计推断时。如果底层分布众所周知，则 bootstrapping 提供了一种方法来解释由特定样本引起的扭曲，这样样本可能无法完全代表总体。
- 需要进行功效计算（power），只有少量样本。大多数功效和样本大小计算都依赖于目标统计量的标准差。如果使用的估计值不对，得到的样本量也会错误。所以一种方法是使用 bootstrapping 对少量 pilot 样本进行估计获得方法。

然而，Athreya 等证实，如果底层总体的方差不是有限（如 power law 分布），那么对样本均值使用简单 bootstrap 不会收敛。因此，基于 bootstrap 的蒙特卡洛模拟的置信区间可能产生误导。因此，除非能确定底层分布不是严重拖尾，否则 应该谨慎使用简单 bootstrap。

## bootstrap 方案

在单变量问题中，通常可以进行放回重采样（case resampling）。在小样本中，首先**参数 bootstrap** 方法，对其它问题，首选**平滑 bootstrap** 方法。

### case resampling

bootstrap 常用于估计统计量，如均值、方差的分布，无法使用正态性假设。具体而言，当没有统计数据分布的解析形式或渐近形式，bootstrap 非常有用。至少有两种方法可以执行 case resampling：

1. 用于 case resampling 的蒙特卡洛算法非常简单。首先，对数据进行有放回重采样，重采样的大小必须等于原始数据集的大小。然后使用 bootstrap 样本计算感兴趣的统计量。多次重复该过程，以获得更精确的统计量的 bootstrap 分布估计值。
2. case resampling 的 "exact" 版本类似，但会详细枚举数据集的所有可能重采样。共有 $\binom{2n-1}{n}$ 种不同的重采样，其中 n 是原始样本大小。因此，对 $n=5,10,20,30$，有 $126, 92378, 6.89 × 10^{10},5.91 × 10^{16}$ 种不同重采样，更耗时。

#### 估计样本均值的分布

抛 10 次硬币，正面为 1，反面为 0，得到 $X=x_1,x_2,\cdots,x_{10}$。假设硬币的平均值呈正态分布，那么可以用 t 统计量来估计样本均值的分布：
$$
\overline{x}=\frac{1}{10}(x_1+x_2+\cdots+x_{10})
$$
这种正态性假设，既可以作为每次抛硬币分布的近似值，也可以作为大量抛硬币平均值分布的近似值。前者近似较差，因为抛硬币的真实分布是伯努利分布，而不是正态分布。后者由于中心极限定理，在无限大样本中是一种有效近似。

当然，也可以直接用 bootstrap 方法，使用 case 重采样得到 $\bar{x}$ 的分布。首先对数据进行重采样得到 bootstrap 样本。由于采用的放回抽样，所以 bootstrap 样本会包含一些重复项。此外，bootstrap 样本大小与原始样本相同。然后计算这个 bootstrap 样本的平均值，得到第一个 bootstrap 平均值 $\mu_1^*$。重复该过程（如 100 次），得到 $\mu_1^*,\mu_2^*,\cdots,\mu_{100}^*$。这代表样本平均值的经验 bootstrap 分布。从该经验分布，可以得到一个 bootstrap 置信区间，用于假设检验。

#### 回归

在回归问题中，case 重采样指对单个样本（通常是数据集的一行）进行简单的重采样。对回归问题，只要数据集够大，这种简单方案也行。但是，这种方法总有人吐槽。

在回归问题中，解释变量通常是固定的，或者至少比相应变量更容易控制。此外，解释变量的范围定义了从中可从中可获得的信息。因此，重抽样意味着每个 bootstrap 样本都会丢失一些信息。因此，应该考虑使用其它 bootstrap 方案。

### Bayesian bootstrap

可以在贝叶斯框架中解释 bootstrapping，通用重新加权初始数据来创建新数据集。给定 $N$ 个数据，

## 提高计算效率

bootstrap 可能占用大量时间和内存。目前已有一些技术用于减轻这种负担，它们通常可以与不同类型的 bootstrap 方案相结合。

### 并行处理

大多数 bootstrap 方法都是高度并行的算法。即每个 bootstrap 的统计量不依赖其它 bootstrap 样本。因此，此类计算可以在单独的 CPU 或计算节点上执行，最终将来自单独节点的结果汇总进行分析。

### Poisson bootstrap

非参 bootstrap 从大小为 n 的列表中抽样，每个元素的个数服从多项分布。如果 $W_i$ 表示元素 $i$ 在给定 bootstrap 样本中出现的次数，则每个 $W_i$ 

## 非参数 bootstrap 方法

bootstrap 方法的目标是基于已知数据去估计未知参数，例如估计均值、中位数、标准差等，构造未知参数的置信区间，以及对参数做假设检验等。

设总体的分布 F 未知，但已经有一个容量为 n 的来自分布 F 的数据样本，自这一样本按**放回抽样**的方法抽取一个容量为 n 的样本，这种样本称为 **boot-strap 样本**，或称为**自助样本**。相继的、独立地自原始样本中取很**多个 bootstrap 样本**，利用这些样本对总体 F 进行统计推断，这种方法称为**非参数 bootstrap 方法**，又称自助法。这一方法可以用于当人们对总体知之甚少的情况，它是近代统计中的一种用于数据处理的重要实用方法。

### 估计量的标准误差的 bootstrap 估计

在估计总体未知参数 $\theta$ 时，人们不但要给出 θ 的估计 $\hat{\theta}$，还需要指出这一估计 $\hat{\theta}$ 的精度。通常我们用估计量 $\hat{\theta}$ 的标准差 $\sqrt{D(\hat{\theta})}$ 来度量估计 $\hat{\theta}$的精度。估计量 $\hat{\theta}$ 的标准差也成为估计量 $\hat{\theta}$ 的**标准误差**。

设 $(X_1,X_2,\cdots,X_n)$ 是来自以 $F(x)$ 为分布函数的总体的样本，θ 是待估计的未知参数。

$\sqrt{D(\hat{\theta})}$ 的 bootstrap **估计步骤**：

1. 对原始样本 $x=(x_1,x_2,\cdots,x_n)$ 按放回抽样的方法抽得容量为 n 的样本 $x……*=(x_1^*,x_2^*,\cdots,x_n^*)$，称为 bootstrap 样本
2. 相继地、独立地求出 B 个（$B\ge 10000$） 容量为 n 的 bootstrap 样本，计算 $\hat{\theta}_i^*=\hat{\theta}(x_1^{*i},x_2^{*i},\cdots,x_n^{*i})$, $i=1,2,\cdots,B$ ($\hat{\theta}_i^*$ 称为 $\theta$ 的第 i 个 bootstrap 估计)
3. 计算

$$
\hat{\sigma}_{\hat{\theta}}=\sqrt{\frac{1}{B-1}\sum_{i=1}^B(\hat{\theta}_i^*-\overline{\theta}^*)^2} \tag{1}
$$

其中，$\overline{\theta}^*=\frac{1}{B}\sum_{i=1}^B\hat{\theta}_i^*$。

> [!NOTE]
>
> 抽样方式：均匀分布随机放回抽样

**例 1** 某种基金的年回报率是具有分布函数 F 的连续型随机变量，F 未知，F 的中位数 $\theta$ 为未知参数。现有以下的 原始样本（单位 %）：

```
9.5 21.1 12.0 10.2 12.0 21.1 10.2
18.2 12.0 9.5 18.0 10.2 18.2
```

试求 F 的中位数的标准误差的 bootstrap 估计。

**解** 将原始样本从小到大排序，中间一个数为 12.0，得中位数为 12.0。相继地、独立地在上述 13 个数据中，按放回抽样的方法取样，取 B=10000。得到 10000 个 bootstrap 样本：

样本 1：

```
10.2 10.2 18.2 18.2 18.2 10.2 10.2 21.1 12.0 18.2
21.1 21.1 12.0
```

样本 2：

```
18.2 9.5 21.1 21.1 10.2 18.0 9.5 10.2 10.2 9.5
10.2 12.0 21.1
```

样本 10000：

```
21.1 9.5 10.2 9.5 12.0 12.0 21.1 18.2 18.0
21.1 12.0 9.5 21.1
```

对以上每个 bootstrap 样本，分别求出样本中位数 $\hat{\theta}_i^*$, $i=1,2,\cdots,10000$。将它们带入（1）式得到所求的标准误差的 bootstrap 估计为：
$$
\hat{\sigma}_{\hat{\theta}}=\sqrt{\frac{1}{9999}\sum_{i=1}^{10000}(\hat{\theta}_i^*-\overline{\theta}^*)^2}=.676131
$$
其中，$\overline{\theta}^*=\frac{1}{B}\sum_{i=1}^B\hat{\theta}_i^*$。

R 代码实现

```R
x <- c(9.5,21.1,12.0,10.2,12.0,21.1,10.2,18.2,12.0,9.5,18.0,10.2,18.2)
median(x)
n = length(x) # 样本量
N = 10000 # bootstrap 次数
k = 0
theta <- numeric(N)
for (i in 1:N) {
    xB <- sample(x, n, replace = TRUE) # 从样本 x 放回抽样 n 个
    theta[i] <- median(xB) # 计算中位数
    k <- k + median(xB)
}
thetabar <- k / N # 中位数平均值
squ <- 0.0 # 平方差加和
for (i in 1:N) {
    squ <- squ + (theta[i] - thetabar)^2
}
sigma.theta <- sqrt(squ / 9999)
```

### 估计量的均方误差的 bootstrap 估计

步骤:

1. 生成 bootstrap 样本
2. 计算统计量：中位数
3. 计算 bootstrap 样本相对原样本的差的平方
4. 重复1-3，得到大量差的平方，取平均值，得到均方误差

**例 2** （均方误差）设金属元素钳的升华热是具有分布函数 F（F 未知）的连续型随机变量。F 的中位数 θ 是未知参数，现测得以下的原始样本（以 kcal/mol 计）:

```
133.7 134.1 134.3 134.4 134.5 134.7 134.8 134.8 134.8
134.9 134.9 135.0 135.0 135.2 135.2 135.4 135.4 135.8
135.8 136.3 136.6 141.2 143.3 146.5 147.8 148.8
```

（数据已排序）。以原始样本的中位数 $M=M(x)$ 作为总体中位数 θ 的估计，试求**均方误差** $MSE=E[(M-\theta)^2]$ 的 bootstrap 估计。

**解** 将原始样本自小到大排序，左起第 13 个数为 135.0，左起第 14 个数为 135.2，于是原始样本的中位数为 135.1。以 135.1 作为总体中位数 θ 的估计，即 $\hat{\theta}=35.1$。需估计均值 $E[(M-135.1)^2]$。

相继地、独立地自原始样本抽取 10 000 个 bootstrap 样本如下：

样本 1：

```
143.3 134.8 148.8 135.4 135.2 135.2 134.8 134.4 134.7
135.2 135.0 135.0 135.4 135.4 136.3 134.4 134.9 134.8
136.6 134.1 134.8 134.8 133.7 134.8 134.8 134.4
```

得样本中位数为 $M_1^*=134.85$，$(M_1^*-135.1)^2=0.0625$。

样本 10000：

```
135.8 135.2 134.9 135.2 135.4 135.2 134.3 134.9
134.3 135.0 134.5 135.8 146.5 143.3 135.0 135.2
148.8 136.6 135.4 136.6 135.2 133.7 146.5 135.0
135.4 134.8
```

得样本中位数为 $M_{10000}^*=35.2$，$(M_{10000}^*-135.1)^2=0.01$。

将这 10000 个数 $(M_1^*-135.1)^2,\cdots,(M_{10000}^*-135.1)^2$ 取平均值，得到：
$$
\frac{1}{10000}\sum_{i=1}^{10000}(M_i^*-135.1)^2=0.07432325
$$
所以均方误差的 bootstrap 估计值为 0.07432325.

### 偏差的 bootstrap 估计

总体分布未知参数 $\theta$ 的估计量 $\hat{\theta}$ 关于 $\theta$ 的偏差定义为：
$$
b=E(\hat{\theta}-\theta)=E(\hat{\theta})-\theta
$$



## Bootstrapping 步骤

1. 生成 bootstrapped 数据集
2. 计算统计量，如均值，中位数、方差等
3. 记录获得的统计量
4. 重复 1-3，直到 bootstrapped 统计量分布较好

以均值为例，大量 bootstrapped 样本获得的均值构成均值的 boostapped 分布，根据分布可以计算置信区间。

## 假设检验

当参数模型假设存在问题，或者无法进行参数推断，或需要很复杂的公式来计算标准误差时，bootstrapping 可以作为基于参数模型的统计推断的替代方案。

## 使用 Bootstrapping 计算 p-value

首先，提出零假设：例如，药物没有效果。



## 疑问

### 采样次数

没有具体的规则来指导样本个数。建议检查样本的直方图，看看分布是否规则。只有 bootstrap 样本的直方图看起来有规律，对统计量的 bootstrap 估计才合理。

如果假设检验是精确的，α 为期望显著性水平，B 为样本数，则必须满足如下条件：
$$
\alpha\cdot(1+B)=integer
$$
Davidson, R., & MacKinnon, J. G. (2000). Bootstrap tests: How many bootstraps?. Econometric Reviews, 19(1), 55-68. 

这篇文献对 p-value 进行 bootstrap 估计，建议对 0.05 最小样本数为 400（即 399），对 0.01 水平最小样本数为 1500（即 1499）。

## 参考

- https://en.wikipedia.org/wiki/Bootstrapping_(statistics)
